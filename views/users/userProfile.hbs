<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{{title}}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        .glass-nav {
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .glass-nav .nav-link {
            color: #000;
        }

        .glass-nav .nav-link.active {
            color: #ff6f00;
            font-weight: 500;
        }

        .glass-nav .navbar-brand {
            color: #000;
        }

        body {
            background: linear-gradient(135deg, #f4f1ec 0%, #dad1c8 100%);
            color: black;
            min-height: 100vh;
            justify-content: center;
            align-items: center;
            font-family: Helvetica;
            margin: 0;
        }

        .glass-card {
            background: rgba(244, 241, 236, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 40px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            width: 100%;
            max-width: 500px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .profile-header {
            margin-bottom: 25px;
        }

        .profile-header img {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            border: 2px solid #F98513;
        }

        .profile-header h4 {
            margin: 15px 0 25px 0;
            color: #F98513;
            font-weight: bold;
        }

        .profile-details p {
            text-align: left;
            font-size: 16px;
        }

        .profile-details strong {
            text-align: left;
            color: black;
        }

        .modal-content {
            background: #f4f1ec;
            color: black;
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .modal-header,
        .modal-footer {
            border-color: rgba(255, 255, 255, 0.2);
        }

        #uploadInput,
        #editProfileImage {
            display: none;
        }
    </style>
</head>

<body>
    <nav class="navbar sticky-top glass-nav">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">
                {{#if user.role}}
                {{#ifEquals user.role "Admin"}}
                Online Airline Ticketing System - Admin
                {{else}}
                Online Airline Ticketing System
                {{/ifEquals}}
                {{else}}
                Online Airline Ticketing System
                {{/if}}
            </span>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavDropdown"
                aria-controls="navbarNavDropdown" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNavDropdown">
                <ul class="navbar-nav">
                    {{#if user.role}}
                    {{#ifEquals user.role "Admin"}}
                    <li class="nav-item"><a class="nav-link" href="/adminSearchPage">Search & Manage Flights</a></li>
                    <li class="nav-item"><a class="nav-link" href="/userManagement">User Management</a></li>
                    <li class="nav-item"><a class="nav-link" href="/reservations">Reservations List</a></li>
                    <li class="nav-item"><a class="nav-link active" href="/userProfile">Profile</a></li>
                    {{else}}
                    <li class="nav-item"><a class="nav-link" href="/searchPage">Search Flights</a></li>
                    <li class="nav-item"><a class="nav-link" href="/checkin">Online Check-in</a></li>
                    <li class="nav-item"><a class="nav-link" href="/reservations">Reservations</a></li>
                    <li class="nav-item"><a class="nav-link active" href="/userProfile">Profile</a></li>
                    {{/ifEquals}}
                    {{else}}
                    <li class="nav-item"><a class="nav-link" href="/login">Login</a></li>
                    {{/if}}
                </ul>
            </div>
        </div>
    </nav>

    {{#if success}}
    <div class="alert alert-success text-center mt-3">{{success}}</div>
    <script>console.log("SUCCESS: {{success}}");</script>
    {{/if}}

    {{#if error}}
    <div class="alert alert-danger text-center mt-3">{{error}}</div>
    <script>console.log("ERROR: {{error}}");</script>
    {{/if}}

    <div class="glass-card text-center mx-auto mt-4">
        <div class="profile-header">
            <img id="profileImg" src="{{user.profileImage}}" alt="Profile Picture">
            <div class="mt-2">
                <button class="btn btn-outline-secondary btn-sm" id="changePicBtn">Change Picture</button>
                <input type="file" id="uploadInput" accept="image/*">
            </div>
        </div>

        <div class="profile-details mt-3">
            <h4 id="displayName">{{user.name}}</h4>
            <p><strong>Name:</strong> {{user.name}}</p>
            <p><strong>Email:</strong> {{user.email}}</p>
        </div>

        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#editProfileModal">Edit Profile</button>

        <button class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#changePasswordModal">Change
            Password</button>

        <button class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#LogoutModal">Logout</button>
    </div>

    <div class="modal fade" id="editProfileModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5>Edit Profile</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-start">
                    <form id="editProfileForm">
                        <label>First Name</label>
                        <input type="text" class="form-control mb-2" id="editFirstName" value="{{user.firstName}}">
                        <label>Last Name</label>
                        <input type="text" class="form-control mb-2" id="editLastName" value="{{user.lastName}}">
                        <label>Email</label>
                        <input type="email" class="form-control mb-2" id="editEmail" value="{{user.email}}">
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-success w-100" id="saveProfileBtn">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="LogoutModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <h5>Logout</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to Logout?</p>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button class="btn btn-danger" id="confirmLogoutBtn">Logout</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="changePasswordModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5>Change Password</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-start">
                    <form id="changePasswordForm">
                        <label for="currentPassword" class="form-label">Current Password</label>
                        <input type="password" class="form-control mb-3" id="currentPassword"
                            placeholder="Enter current password" required>

                        <label for="newPassword" class="form-label">New Password</label>
                        <input type="password" class="form-control mb-3" id="newPassword"
                            placeholder="Enter new password (min. 6 chars)" required minlength="6">

                        <label for="confirmNewPassword" class="form-label">Confirm New Password</label>
                        <input type="password" class="form-control mb-3" id="confirmNewPassword"
                            placeholder="Confirm new password" required>

                        <div id="passwordErrorMsg" class="mt-3 text-center" style="color:red;"></div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-primary w-100" id="savePasswordBtn">Save New Password</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            console.log("SESSION USER:", {{{ json user }}});
        const profileImg = document.getElementById('profileImg');
        const changePicBtn = document.getElementById('changePicBtn');
        const uploadInput = document.getElementById('uploadInput');

        changePicBtn.addEventListener('click', () => uploadInput.click());
        uploadInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => profileImg.src = event.target.result;
                reader.readAsDataURL(file);
            }
        });

        const logoutBtn = document.getElementById('confirmLogoutBtn');
        if (logoutBtn) logoutBtn.addEventListener('click', () => window.location.href = '/logout');

        const changePasswordForm = document.getElementById('changePasswordForm');
        const savePasswordBtn = document.getElementById('savePasswordBtn');
        const passwordErrorMsg = document.getElementById('passwordErrorMsg');

        savePasswordBtn.addEventListener('click', async (e) => {
            e.preventDefault();
            passwordErrorMsg.textContent = '';

            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmNewPassword = document.getElementById('confirmNewPassword').value;

            if (!currentPassword || !newPassword || !confirmNewPassword) {
                passwordErrorMsg.textContent = 'All fields are required.';
                return;
            }
            if (newPassword !== confirmNewPassword) {
                passwordErrorMsg.textContent = 'New passwords do not match.';
                return;
            }
            if (newPassword.length < 6) {
                passwordErrorMsg.textContent = 'New password must be at least 6 characters.';
                return;
            }

            const data = {
                currentPassword,
                newPassword,
                confirmNewPassword
            };

            try {
                const res = await fetch('/users/change-password', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await res.json();

                if (result.success) {
                    changePasswordForm.reset();

                    alert(result.message);
                    window.location.reload();
                } else {
                    passwordErrorMsg.textContent = result.message;
                }
            } catch (err) {
                console.error(err);
                passwordErrorMsg.textContent = 'Server error. Please try again.';
            }
        });            
        });
    </script>
</body>


</html>
